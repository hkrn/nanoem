==========================================
トラブルシューティング
==========================================

nanoem で利用する際に問題が発生したときの回答一覧です。トラブル関連ではないよくある質問と回答については「:doc:`faq`」にまとめています。

.. _0ACEC098-CB5E-40E2-99C5-01DB3BCBE080:

nanoem が開かない、起動しない
=======================================================

.. important::
   macOS 10.12 を利用している場合は起動直後に落ちる問題を確認しているため可能であれば macOS 10.13 以降にアップグレードしてください。
   なお、この問題は 29.1 以降で修正しています。

起動時に警告ダイアログが出る場合は「`Mac で App を安全に開く <https://support.apple.com/HT202491>`_」の「ノータリゼーションを受けていない App や未確認の開発元の App を開く方法」を確認してください。

ダイアログなしに起動しない場合は起動時に必要なフォルダのアクセス権限が不適切なことが原因の可能性があります。詳細は以下を参照してください。

- `Mac OSXで急にソフトが起動しなくなったときはアクセス権を疑ってみよう <http://otowacreation.co.jp/archives/453>`_
- `ファイルやアプリケーションが突然開けなくなった！ <https://dekiru.net/article/442/>`_

それでも解消しない場合は使っている macOS のマイナーバージョンが古いことが原因の可能性があります。ソフトウェア・アップデートより macOS のマイナーバージョンの更新を行ってください。

- `Mac のソフトウェアをアップデートする <https://support.apple.com/HT201541>`_

.. _2956D851-EA68-4AA6-8A91-396A8B74AF44:

音源が読み込めないあるいは音がでない
=======================================================

.. important::
   31.5.0 において WAV 以外の音源が読み込めない場合がある不具合の修正及び音源読み込み時のエラー検出の強化を行いました。

   エラーが出ない場合は「`Macのスピーカーの音が聞こえない場合 <https://support.apple.com/guide/mac-help/mchlp1439>`_」を確認してください。また、ミュートになっていないかの確認を行ってください。

音源が読み込めないケースで macOS 版の場合

* iTunes か QuickTime で読み込むことができるかを確認してください

  * それらで読み込めない場合は nanoem でも読み込めないので音源を確認してください

* iTunes または QuickTime で読み込めるが nanoem で読み込めない場合は一回 wav (PCM) 形式に変換してから nanoem に読み込ませてください

音源が読み込めてるが音源全体で音が出ないケースの場合は

* 他のアプリでは音が出るが nanoem で音が出ない場合は :ref:`8DF11AFA-D8D1-4A15-B8E7-B9BBB246C7FD` の音量が 0% になっていないことを確認した上で nanoem を再起動してください
* nanoem 含む他のアプリでも音が出ない場合は Windows/macOS を再起動してください

謎の爆音が発生することがある
=======================================================

macOS において起動してから数時間が経過しかつ音源が読み込まれた状態で爆音が発生することがある現象が報告されていますが、2021/7/14 現在でも原因がわからないため長時間作業が想定される場合は以下で対応してください。

* 「:ref:`BCE5BB55-78D2-4B89-876F-85BA69E6022C`」を行う
* nanoem を再起動する

背景動画が読み込めない
=======================================================

macOS 版においては QuickTime で読み込み可能かどうかを確認してください。QuickTime 以外の場合は `VLC <https://www.videolan.org/vlc/>`_ あるいは `IINA <https://iina.io>`_ で確認します。
QuickTime/VLC/IINA いずれも読めない場合はそもそも動画として正しく認識できていない可能性が高いです。

読み込むとクラッシュする場合は avi 形式に変換することで内部で使われる実装が切り替わるため読み込める可能性があります。

プロジェクトが読めなくなってしまったのですが
=======================================================

.. important::
   31.5.0 以降 nmm 形式においてプロジェクトファイル読み込み時に部分的にファイルが読み込まれなかった場合は何が読み込まれなかったのかをダイアログ表示するようにしました。

   25.0.0 以降では音源または動画のファイルが見つからない場合はエラーではなく単純に読み込みを無視するようになりました。
   そのため、音源または動画が読み込まれない場合は元のファイルが何らかの理由で見つからないことが原因の可能性があります。

`bowlroll <https://bowlroll.net>`_ または何らかのアップローダを使ってプロジェクトファイル一式をアップロードし、本人と開発者以外からみて秘匿出来る形 [#f1]_ で
:ref:`37420267-8E5A-41EA-A159-FFF490DF1D8D` で報告してください。
可能な限り対処しますが、プロジェクトファイルの状態によってはだめな場合があります。

.. _9E2F9ADC-69F3-45C7-A89F-E3B58131EE6F:

プロジェクトが保存出来ないのですが
=======================================================

.. important::
   - ボーンまたはモーフを動かした状態でキーフレーム未登録が残ったままプロジェクトを保存しようとするとエラーが出ます。
   - 31.0 まで既存のモーションを読み込んで保存しようとすると場合によってエラーで保存できない、もしくは最初のキーフレームしか保存されない不具合がありました。当該不具合は 31.1 で修正しています。
   - 26.0 までモデルまたはアクセサリを削除してから保存すると必ず失敗する不具合がありました。当該不具合は 26.1 で修正していますが、もし 26.1 未満で継続利用する場合はモデルまたはアクセサリの削除をしないようにお願いします。

「保存先に異常がないかを確認してください」のエラーが出た場合は以下の原因の可能性があります

- 上記の「重要」のところに引っかかてないか
- 保存先がのストレージ容量が足りていないか
- 読み込み専用に対して保存している

２番めの場合は `GrandPerspective <http://grandperspectiv.sourceforge.net/>`_ などを利用して不要なファイルを削除し、ストレージ容量を確保してください。
３番目の場合は保存先を変更する（例えばデスクトップなど）ことによって保存できる可能性があります。

これらでも対処できない場合は macOS の場合は「Mac の問題を診断する」で Mac 本体に異常がないかを確認してください。

上記以外の場合は使ってるバージョンが最新版かどうかを確認し、どういった問題が発生して保存できてないのかを書いた上で
:ref:`37420267-8E5A-41EA-A159-FFF490DF1D8D` で報告をお願いします。

.. _1A68F001-C7E3-41FD-A1AC-0D84505D38DC:

モデルが正しく表示されない
=======================================================

.. important::
   33.0 から「:ref:`D102480C-FFFB-43BA-9561-291E1AF4255B`」が追加されました。表示トラブルが発生している場合は実行して確認してください。

もし全部あるいは部分的に白く表示されている場合はモデルのテクスチャが正しく読み込まれてない可能性があります。
この場合は一回問題が発生しているモデルを退避し、必要に応じてモデルのダウンロードを行い zip などの圧縮ファイルを展開しなおしてください。

macOS 版の場合は zip 解凍時のファイル名の文字化けが原因でモデル表示が正しく行われないことがあります。その際「:ref:`0C54A757-1FA3-4CC9-B33E-E9362B69A25B`」にあるように専用のアプリケーションを使ってください。

上記以外の部分的に正しく表示されていない場合は :ref:`37420267-8E5A-41EA-A159-FFF490DF1D8D` にて報告をお願いします。
原因が多岐に渡るため、一概にいえる解決策がないためです。

また、もし以下のような現象が発生している場合

- モデル読み込むとボーンしか表示されない
- 画面が真っ黒

描画エラーの可能性が疑われますが根本的な原因不明で、解決策がない状態です。応急的な対処として以下の順で試してください。

- nanoem を再起動する
- 上でダメなら Mac を再起動する

  - 起動後に常駐するアプリケーションも重要なもの以外を落とすこと
  - 使用するとき nanoem 以外のアプリケーションを立ち上げない

モデルを読み込んだら落ちる
=======================================================

「設定」の「全体設定」にある「モデル描画の負荷分散を有効にする」のチェックを外してモデルを読み込んでください。

それでも落ちる場合は落ちたモデルの情報提供（配布元が分かる場合その場所をのせる）とともに
:ref:`37420267-8E5A-41EA-A159-FFF490DF1D8D` で報告をお願いします。

モデルの足の部分がガクガクする
=======================================================

IK の仕様です。特にモーションの作成元モデルと読み込み対象のモデルの身長差が大きいと意図した位置を求めることができずより顕著になるため以下の方法で対処してください。

* 「編集」の「:ref:`54256F37-C4E0-4642-9AB4-8720FACBE207`」で補正する
* 「:ref:`E6F3DE0F-97F9-4515-ABC0-58B8999A9E70`」から対象の IK ボーンを選択し `Off` をクリックして「登録」を押す

  * 登録後ガクガクしている IK リンクボーンを改めて回転し直してボーンパネルからキーフレーム登録

    * IK リンクボーンはボーン選択画面において黄色で表示されます
    * IK ボーンは Off の状態において動かしても何も機能しないため動かす必要はありません

アクセサリを読み込んでも何も表示されない
=======================================================

アクセサリファイルを開いて中身が1行に全て詰め込まれている場合は実装都合上 nanoem で正しく解析が行うことが出来ないため読み込むことが出来ても何も表示されません。

対策として Metasequoia を利用してファイルを一回取り込んで別のファイル名で保存するか、
あるいは `homebrew <https://brew.sh>`_ などで `assimp <http://assimp.org>`_ をインストールして以下のコマンドラインで変換を行ってください。

.. caution::
   Blender ではアドオン経由での書き出ししか対応しておらず、加えて 2.80 以降に対応していません

.. code-block:: none

   # homebrew の場合
   brew install assimp

   # input.x は nanoem で読み込めないアクセサリファイルのパス
   # output.x は書き出し先、ファイル名は任意
   assimp export /path/to/input.x /path/to/output.x

アクセサリまたはエフェクトを読み込んだら落ちる
=======================================================

落ちたアクセサリまたはエフェクトの情報提供（配布元が分かる場合その場所をのせる）とともに
:ref:`37420267-8E5A-41EA-A159-FFF490DF1D8D` で報告をお願いします。

.. _087A9DEC-BE10-4162-8D08-293B6936ADCC:

新規プロジェクト作成のたびにエラーが表示される
=======================================================

オーディオ出力の初期化に失敗している可能性があります。他のアプリケーションで音が鳴るかを確認してください。
なお、エラーが出ても再生は可能ですが音源を読み込んでも鳴りません。

動画出力を行うと落ちる
=============================================================================

32.0 未満の場合はアンチエイリアスを有効にすると落ちる問題が確認されています。
もし 32.0 未満の場合は 32.0 にアップデートするか、アンチエイリアスを無効にして書き出してください。

32.0 以上の場合でも場合によってはアンチエイリアスを有効にした状態で落ちることがあります。
その場合は別途アンチエイリアスエフェクトを利用する形でアンチエイリアスを無効にして書き出してください。

動画出力で音ズレが起きる
=============================================================================

34.1 未満の場合以下の条件を満たす場合に途中から書き出しにもかかわらず音源の最初からはじまる不具合がありました。

* 音源を読み込ませている
* 動画書き出しの設定で開始フレームを０より大きく設定している
* 「OS 付属のエンコーダを有効にする」を外している

34.1 以降で修正していますが、34.1 未満の場合は開始フレームを０に設定して動画を書き出して動画編集で調整してください。

また、以下の条件で書き出した動画で動画プレイヤーによってはカクつく問題があります。

* ``plugin_lsmash`` で書き出し
* サンプルビット数が 24bit かつ周波数 48000Hz の音源が使われている

上記に引っかかる場合は ``plugin_ffmpeg`` で書き出すか、音源をサンプルビット数を 16bit 及び周波数を 44100Hz に変換してください。

動画出力で書き出すと意図しない（例えば真っ黒）動画が出力される
=============================================================================

もし「OS 付属のエンコーダを有効にする」にチェックをつけて出力していた場合は無効にし、かわりに Plugins の欄から ``plugin_lsmash`` を選択して動画出力を行ってください。

:ref:`9816D13E-ADA9-44D9-A869-1F61537D7753` が OpenGL の場合でかつ利用可能な場合は Metal に切り替えることによって解決することがあります。

それでも解決しない場合は macOS のバージョンをあげてダメなら nanoem での動画出力を諦めて QuickTime Player の画面収録を使うしかありません。

.. _19861EBC-2EFD-4FB8-A9A3-796E826F337D:

動画出力で書き出すと再生では起こらなかったフレーム欠けが起こる
=============================================================================

.. important::
   31.5 から動画出力設定画面に「フレームズレ抑止を有効にする」が追加されました。もし無効になっている場合は有効にしてください

「OS 付属のエンコーダを有効にする」を有効にすると発生することまでは確認できています。が、
技術的仕様上原因不明で修正できない状況のため、以下の方法で対処してください。

- :ref:`087A9DEC-BE10-4162-8D08-293B6936ADCC` にある方法で対処する
- 動画編集でフレーム欠けを起こしてる箇所を取り除いて前後のフレームから補完する

ウィンドウ画面が水色に表示される
=======================================================

レンダラに OpenGL を利用している場合 nanoem 側の不具合によって発生します。もし遭遇した場合は
:ref:`37420267-8E5A-41EA-A159-FFF490DF1D8D` で報告をお願いします。

レンダラが Metal だと発生しないため報告しない限り放置される可能性が高いです。

.. _C2D34D8E-AB86-4291-A3B7-C030CB6333B3:

カメラモーションを読み込んだら角度の X 軸が反転する
=======================================================

.. important::
   33.0 で修正済みです。32.0 以前に保存したプロジェクトは読み込み時に補正します。

32.0 以前の不具合によるものです。「編集」＞「カメラ」＞「補正ダイアログを開く」の「角度」の最初の項目の ``* 1.00`` を ``* -1.00`` に変更し、「OK」で実行してください。

物理演算で貫通を起こす
=======================================================

物理演算部分は現在も調整中のため貫通（とくにスカート）が起こりやすいです。物理演算の仕様もあり一律で完全に防ぐことが不可能のため、以下を試してください。

- カメラで貫通部分を隠す

  - 一番簡単な方法だが見せられる部分が減る

- 剛体またはジョイントのパラメータを調整する

  - 設定画面からモデル編集機能有効にしたあとメニューの「編集」の「モデル編集ウィンドウ」を開くと出る「剛体」と「ジョイント」のパラメータは編集可能です
  - ただし操作と調整が非常に難しいためどうしてもという時のみ使ってください

-  :ref:`54B1F974-2B39-4472-B6F5-EAB40FDCC4F7` の「物理」のチェックボックスを外して登録する

  - 「:ref:`166E84B9-236D-41F4-9FD0-CCA457D28076`」を参照
  - 26.0 以降から実装された機能で「物理」のチェックボックスを外して登録したキーフレームは物理演算が無効になります
  - 有効と無効の間の補完仕様があるため扱いが難しいですが、物理演算の切り替えを制御できる唯一の手段となります

カメラを動かすとセルフシャドウが消えることがある
=======================================================

.. important::
   29.0 未満までセルフシャドウの計算方法に問題があり、これを修正したため頻度は軽減しています。

セルフシャドウの仕組みの限界による仕様で、不具合ではありません。
発生した場合はモードを切り替えるかセルフシャドウの有効距離を調整してセルフシャドウのキーフレームに登録してください。

外付け GPU を搭載している Mac をお使いの場合は ExcellentShadow などの上位なセルフシャドウ用エフェクトを利用する手もあります。
完全になくすことはできませんが、発生しにくくなります。エフェクトの README にもありますが適用すると動作が重くなります。

.. _0C54A757-1FA3-4CC9-B33E-E9362B69A25B:

zip を解凍したらファイル名が文字化けしたのですが
=======================================================

`The Unarchiver <https://itunes.apple.com/jp/app/the-unarchiver/id425424353>`_ などのアプリを使って解凍してください。これは zip 内のファイル名の文字コードを日本語版 Windows 以外では正しく認識できないことが原因です。

MMD における zip はほとんどが日本語版 Windows で作られてるので日本語版の Windows では問題ないのですが、
日本語以外の Windows 及び macOS などで扱う場合は上記の理由により文字化け問題を引き起こします。

タイムラインとビューポートの分離はどうやったらできるの？
=============================================================

33.0 以降から「:ref:`5BB93875-36E2-42A2-B232-BD61D8FD131D`」で分離することができます。
それより前のバージョンはタイムラインとビューポートの比率のサイズ調整のみ可能です。

ただし MMD のように独立したウィンドウとして分離するのではなく、あくまでアプリケーション内のウィンドウとして分離される形のためウィンドウを外に持っていくことはできません。

外部親設定したら意図しないモデルに紐付いた
=============================================================

外部親の対象モデルは名前で紐づく仕様のため、モデル名がプロジェクト内で重複する場合（同じモデルで複数回読み込むと発生します）は最初のモデルが外部親に設定されます。

モデル名が重複している場合は「:ref:`62EB4D2C-F84D-4B9A-A942-4216F524C01A`」を参照の上で設定対象以外のモデル名を変更してください。

一時停止を繰り返すと再生時にかくつくんですが...
=============================================================

.. note::
   音源を読み込まなくても当該問題が発生します。これは内部的に無音の音源が読み込まれるためです。

音源同期補正処理による影響です。一時停止を繰り返すと音源のズレが大きくなり音源同期補正処理が毎回強制的に働くためです。

対処方法として画面右下の一時停止ではなくメニューのほうの停止を選択してください。補正処理がリセットされるためかくつきが発生しなくなります。
ただし停止後に一時停止を繰り返すと再発します。また、音源同期補正処理を無効にする方法は提供していません。

一部文字が「？」と出て表示されない
=============================================================

nanoem では組み込みフォントとして源暎フォントのひとつである `源暎ゴシックP <https://okoneya.jp/font/genei-gothic.html>`_ を利用しているため、当該フォントに収録されていない文字は表示できません。これについては仕様です。

また内部処理の関係上、ASCII および日本語以外の文字の表示は対応していません。

.. _F6684DC6-51A9-49DB-B4E8-7C1CF8BAF23B:

VRM から変換したモデルを読み込ませるとボーン表示のみになる
=============================================================

24.x 系以前に起きていた VRM 変換時に付属するシェーダを起因とする不具合によるものです。以下の方法で対処してください。

- 25.0.0 以降を利用する
- (24.x 系以前を使い続ける場合) 付属シェーダを削除するか書き換える

  - 書き換える場合は `half2` `half3` `half4` をそれぞれ `float2` `float3` `float4` に書き換える
  - どちらにせよトゥーン表示が間違ったままのため意図した色にならない問題が残る

    - トゥーン表示が間違ってる問題は 25.0.0 以降で対策しています

.. _3E2C6DB6-B21C-4A7D-9A6E-F4C872C7486E:

macOS 10.15 以降で「キーボード入力監視」の確認を求めるダイアログが表示される
=============================================================================

macOS 10.15 Catalina で導入された仕様のため可能であれば当該問題に対処した 25.0 以降を利用してください。
トラックパッド有無の検知で利用してるため無効にした場合でも動作に支障をきたす問題はありません。

OSStatus returns 560558962 が出る
=======================================================

.. note::
   24.0 の不具合で WAV 以外の音源を読み込むと発生してました。24.1 で修正してます

nanoem が利用している macOS の AVFoundation のエラーです。

音源を WAV(PCM) に変換してから読み込んでください。また、発生原因である音源の周波数
（サンプリングレート）が 8KHz から 192KHz 以内におさまってるかを確認してください。
それでもなおらない場合は :ref:`37420267-8E5A-41EA-A159-FFF490DF1D8D` にある手順で報告をお願いします。

OSStatus returns 2003332927 が出る
=======================================================

上記に同じく AVFoundation のエラーですが、こちらは発生原因が不明のため
:ref:`37420267-8E5A-41EA-A159-FFF490DF1D8D` にある手順で報告をお願いします。

This effect cannot be compiled due to the renderer is not OpenGL が出る
================================================================================

.. warning::
   - エフェクト詰め合わせは配布を終了しました
   - macOS では OpenGL が非推奨のため将来的に動かなくなる可能性があります

これはレンダラが OpenGL 以外の環境でかつ過去に配布されていた「エフェクト詰め合わせ」に含まれるエフェクトを使用してると発生します。
対処法については :ref:`986802EC-851B-46B8-A7D0-287AA1294F0E` を参照してください。

 .. [#f1] BowlRoll つかってるなら「指定ユーザのみアクセス許可」で ID:145 を指定すると確実です。 c.f. `投稿者のための BowlRoll の使い方まとめ <https://potmum.dokku.hikarin.jp/@shimacpyon/items/5b56515d65e14c829df46192a6da1a94>`_
