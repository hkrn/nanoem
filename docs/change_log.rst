=======================================================
変更履歴
=======================================================

.. note::
  29.2.0 以前の変更履歴は :doc:`change_log_past` を参照してください

33.2.0
******************************************

不具合修正
==========================================

* macOS において爆音が発生する現象を抑制する予防策を追加

33.1.0
******************************************

不具合修正
==========================================

* macOS 10.14 未満で利用すると落ちる
* ボーンをカーソルに当てたときのツールチップが表示されない
* 特定のアクセサリファイルを読み込むと落ちる

33.0.0 (2021/6/10)
******************************************

機能追加
==========================================

* モデル編集機能を大幅強化

  * 利用可能な機能については :doc:`model` を参照してください

* モデル上に表示されるハンドル操作時に選択中のボーンの接続情報を表示するようにした
* ビューポート右下に表示されるハンドル操作時に選択中のボーンの操作軸を表示するようにした
* 以下のメニューアイテムを追加（下２つはモデル編集用途のためデフォルトでは表示されない）

  * :ref:`D102480C-FFFB-43BA-9561-291E1AF4255B`
  * :ref:`5BB93875-36E2-42A2-B232-BD61D8FD131D`
  * :ref:`EEE59B7A-FB14-48E3-B63F-D39AF815CE51`
  * :ref:`07D2C58A-8399-48F6-A21E-C0D49D9C59FF`

* Grass Valley HQX Codec でエンコードされた動画を :ref:`4BF77CBD-F154-479A-8CC6-83F19677CB04` として利用できるようにした

  * 背景動画として使えるようにするのみで Grass Valley HQX Codec での動画書き出しはできません。また書き出し対応の予定もありません
  * ffmpeg による互換実装のデコーダのため動画によっては正しく読み込めない場合があります

* 「選択」において ``Alt + Shift`` を押しながらドラッグすると回転する機能を追加
  
  * 実験的な機能のため予告なく仕様変更または削除する可能性があります

仕様変更
==========================================

* モデル上に表示される移動または回転ハンドルを操作中選択されていない軸を半透明にする処理を追加
* 「右腕」または「左腕」を親に持つボーンに対してローカル軸を自動的に設定するようにした
* 選択されたボーンが移動または回転不可の場合ビューポート下のパラメータ入力のそれぞれの項目を無効にするようにした
* 高解像度ビューポートまたはアンチエイリアス有効時にビューポートに表示されるボーン接続やハンドルなどのアンチエイリアスを有効にするようにした

  * 変更前は表示負荷対策のため一律で無効にしていました

* 設定画面などの子ウィンドウの移動をタイトル部分のドラッグのみに制限するようにした

  * 変更前は子ウィンドウ内の任意の箇所にドラッグすると移動できる状態でした

* 非表示のモデルに対して物理演算を発生させないようにした

  * MMD の場合はモデルが非表示であっても物理演算の衝突判定が発生するのでご注意ください

* モーションファイルの読み込み時にカメラ及び照明のモーションかモデルモーションかをチェックするようにした

  * 従来は単純に無視していましたがそれゆえ間違って読み込んだ場合に認識できない問題があるためエラーを出すようにしました
  * 古い nanoem でカメラ及び照明モーションを書き出したファイルには対象名が設定されていないためエラーが出る可能性があります

* モデルモーションを読み込むときモデルが選択されていない場合はエラーを出すようにした
* モデルモーション読み込み時に対応するボーンあるいはモーフが見つからなかった場合は警告を出すようにした

不具合修正
==========================================

* モデル上に表示される移動または回転ハンドルを操作すると位置が飛ぶことがある
* ビューポート設定変更でマウスカーソルの位置ズレを起こすことがある
* Windows 版で DirectX 利用時に対応しない MSAA を指定すると落ちる
* Windows 版において DPI の異なるディスプレイに移動させたときスケールがおかしくなる
* プロジェクトが相対パスで保存されているにもかかわらず設定上では絶対パスが指定される
* カメラのズームインあるいはズームアウトするとモーフの変形状態がリセットされる
* 戻す方向にシークすると材質モーフがリセットされる
* カメラ原点から遠く離れた場所からリセットする時にモデルのエッジ表示が異常に太くなる
* エフェクト設定画面を開いてない状態でエフェクトファイルを割り当てると落ちる

  * エフェクト設定画面を開くように指示するエラーを出すように変更しました

* 非パースペクティブ時のカメラ計算が不正なことが原因で非パースペクティブを選ぶと何も描画されていないように見える
* ``shared`` キーワードを利用したエフェクトにおいてオフスクリーン内の描画対象が描画されないケースがある

  * 具体的には `msToonCoordinator <https://note.com/mashimashi_note/n/na1bc7c72e511>`_ で問題が顕在化

* モデル読み込み時にテクスチャが格納されているフォルダがモデルフォルダの外側にあると白く表示される
* プロジェクト保存時にモデルが未選択の場合読み込み時に未選択状態が反映されない
* Windows 版でエラー表示において文字化けが発生することがある
* ``Post_ScreenTex.fx`` を利用すると描画が正しく行われない
* カメラモーションを読み込んだときのアングルが間違っている（X 軸が反転している）

  * 32.0 以前で保存されたプロジェクトについては読み込み時に自動的に補正します
  * カメラモーションとして書き出してそれを読み込んだ場合は補正しないため元のプロジェクトから再度書き出してください

* プロジェクト読み込み失敗時及びエフェクトのメモリリークが発生していた問題
* 24bit 音源読み込み時に波形表示が行われない
* 背景動画に音源が含まれている場合正しくデコードされない場合がある
* エフェクト利用時に背景動画が正しく表示されない場合がある
* Windows 版において背景動画つきでプロジェクト保存した後それを読み込んだ場合背景動画が表示されない
* Windows 版において画像あるいは動画書き出しの時プロジェクト変更があったときの保存確認ダイアログが表示されない

32.0.0 (2021/3/8)
******************************************

機能追加
==========================================

* ソフトボディ実験的対応

仕様変更
==========================================

* nanoem アプリにおける Google Analytics (Google Measurement Protocol) の利用廃止

  * 詳細は :doc:`privacy` にて
  * Sentry によるクラッシュレポート機能は引き続き使われます

不具合修正
==========================================

* 画像あるいは動画出力時にポストエフェクトが含まれる状態でアンチエイリアスを有効にして実行すると落ちることがある
* アンチエイリアス設定後にエフェクトの RENDERCOLORTARGET セマンティックのテクスチャに対してアンチエイリアスが適用されない

  * 画像あるいは動画書き出しにおいてアンチエイリアスを有効にしてもポストエフェクトに対するアンチエイリアスが行われてなかった
  * オフスクリーンテクスチャはエフェクト側で制御する仕組みのため影響を受けない

* 画像あるいは動画出力画面時に出るダイアログを一回キャンセルし、もう一度行って破棄を押すとダイアログが二重に出てしまい落ちることがある
* macOS 版において Metal 利用時に「OS 付属のエンコーダを有効にする」にチェックを入れた状態で書き出すと真っ黒な動画が生成される
* Windows 版でメニューのアクセスキー（ニーモニック）が正しく機能しない
* Windows 版でファイル保存時に拡張子が二重になってしまうことがある

31.5.0 (2021/2/22)
******************************************

機能追加
==========================================

* nmm 形式のプロジェクトファイル読み込み時にアクセサリまたはモデルの読み込みが失敗した時何が原因で読めなかったか表示するようにした
* :ref:`A83521E4-540E-4C96-8093-07684B994454` に 「フレームズレ抑止を有効にする」を追加

  * 31.2.0 で導入した書き出し高速化で垂直同期の速度を上回ると動画書き出し結果が不正確になる問題があったため

不具合修正
==========================================

* 言語設定を英語にした時反転ペーストが機能しない
* :ref:`F3B3AAC8-0D8C-4409-8439-8764F37F2962` が実質的に機能しない
* ``plugin_avfoundation`` において音源のデコードに失敗することがある

  * macOS において WAV 音源以外の読み込みに失敗してた原因になってた可能性が高い

* 接続先剛体がないジョイントが含まれたモデルを読み込ませると落ちる

  * ただしそのモデルは MMD で読み込ませると確実に落ちるので注意が必要です

31.4.0 (2021/1/21)
******************************************

不具合修正
==========================================

* 物理演算の焼きこみを行うと落ちる

  * 内部的にはモデルキーフレームにおける物理演算の有効無効の切り替え時に落ちる問題があった

* キーフレームを選択した状態かつ補完曲線表示した状態で巻き戻しを実行すると落ちる
* 言語変更時にアンチエイリアスメニューの消失およびメニューのチェック状態が正しくリストアされない
* メニューの地面影が本来有効なのでチェックされてるべきなのにチェックされてない
* macOS の OS 付属エンコーダを利用して書き出した結果が不正になる

  * 動画書き出しで落ちやすくなる問題をある程度修正して安定性を向上させた

31.3.0 (2021/1/15)
******************************************

仕様変更
==========================================

* モーフ変形時キーフレームに未登録のボーンの変形状態を含めて保存するようにした

  * いままではモーフを変形させるとボーンの変形状態をリセットする仕様だった

* PMX 2.1 で定義されているフリップモーフ及びインパルスモーフを暫定的に実装
* 次バージョンでのソフトボディ対応のためソフトボディ対応の物理演算実装に切り替え

  * 上記により物理演算で動作が変わる可能性があるかもしれません
  * ソフトボディのあるモデルの読み込みは 31.3.0 から対応していますが動作はしません

不具合修正
==========================================

* 頂点が存在しないモデルにおいてモーフ処理が行われない
* nmm 形式のプロジェクト保存時に物理演算の無効及びトレースモード以外の処理モードを選択した場合保存されない
* macOS 版上でプロジェクト保存したときファイルパスに濁点半濁点が含まれると macOS 以外でプロジェクトを開こうとしたときアクセサリまたはモデルが読み込めない

  * macOS 上でしか使わない場合は対応不要です
  * もし macOS 以外で使う場合は影響を受けない macOS 版を利用して以下の対応を行ってください

    * 該当するアクセサリまたはモデルのモーションを一回書き出して 31.3 以降で読み込みし直した上で保存してください
    * アクセサリまたはモデルのファイル名だけでなくフォルダ名も対象となります

* macOS 版において OS 付属のエンコーダ利用時に書き出しすると落ちることがある
* 特定のテクスチャの不正デコードによりそれを利用するテクスチャのアクセサリまたはモデル描画に意図しない描画が発生する
* プロジェクト再生終了時の処理漏れによりアクセサリ、カメラ、光源、セルフシャドウが正しくリセットされない
* Windows 版で初回起動時に落ちる不具合が別要因で残ってた
* Windows 版で再生がかくつく

  * 再生と一時停止を繰り返すと音源の同期補正処理の関係でかくつく問題があります
  * 上記問題は一時停止ではなく停止を行うことにより同期補正処理がリセットされるため、かくつきがなくなります

* 内部的な安定性向上のための対応（落ちる箇所を特定できた箇所について修正）

31.2.0 (2021/1/3)
******************************************

仕様変更
==========================================

* 動画書き出しの処理の見直しにより処理速度を改善

不具合修正
==========================================

* macOS 版において Metal で動作時ウィンドウをリサイズするとレイアウトが崩れる
* macOS 版において Metal で動作時にハングして CPU が高負荷状態のまま反応しないことがある

  * プロジェクトの新規作成、プロジェクトの開き直し、再生もしくは編集時の FPS 変更において高確率に発生する

31.1.0 (2020/12/31)
******************************************

仕様変更
==========================================

* macOS 版において以下の拡張子を nanoem で直接開けるように拡張

  * nma
  * nmd
  * nmm
  * pmd
  * pmm
  * pmx
  * vmd

不具合修正
==========================================

* 既存のモーション流し込みでプロジェクト保存したとき不完全な状態で保存されることがある

  * プロジェクト保存時「不完全なデータが保存されようとしたため保存が中断されました」エラーの原因と同一の可能性あり

* 背景動画が正しく描画されない

  * 31.0.0 の描画処理変更による影響が原因

* 内部変更により ``TEXTUREVALUE`` を利用したエフェクトの処理速度を改善
* モデルごとにレンダーターゲットを必要とするエフェクトにおいてメモリ使用量が激増する
* Metal 上で点描画を利用するエフェクトにおいて異常描画が発生する

31.0.2 (2020/12/25)
******************************************

不具合修正
==========================================

* Windows 版で起動直後に落ちる

31.0.1 (2020/12/25)
******************************************

不具合修正
==========================================

* macOS 版でかつ OpenGL 上での動作時ウィンドウをリサイズしようとすると落ちる

31.0.0 (2020/12/25)
******************************************

機能追加
==========================================

* Apple Silicon Mac の暫定対応

  * 描画処理の全面的な見直しのため Apple Silicon 以外でもパフォーマンスが改善する可能性があります
  * nanoem > Preferences... > 「システム情報」の CPU が ``ARM (64-bit)`` であれば Apple Silicon ネイティブで動作しています

* PMM ファイルの書き出しを実装

  * 注意事項については :ref:`D90328CC-C39A-4854-BB48-B49039D8E31B` を参照してください

* PerMonitor v2 の対応

  * DPI の異なるディスプレイへの切り替えでメニューのフォントサイズが正しく追従するようになります
  * Windows 版のみ

仕様変更
==========================================

* 内部で利用しているグラフィックスライブラリの制限値の引き上げ

  * 31.0 未満を利用している場合は自動的に引き上げされませんので nanoem > Preferences... > Special にある Initialize ボタンを押してください
  * 通常利用で引っかかることはまずありませんが、エフェクトを多用している場合はこれ起因で落ちることがあるため上記による引き上げを推奨します

* Visual Studio 2015 から Visual Studio 2017 のランタイムに切り替え

  * Windows 版のみ

* ミップマップ生成をデフォルトで無効に変更

  * 現状の処理が潜在的に落ちる原因を作ってしまうため

不具合修正
==========================================

* オフスクリーン Main における個々のモデルまたはアクセサリの表示切り替え及び消去が正しく動作しない
* 解像度倍率の異なるディスプレイへの移動時に倍率追従が正しく行われない

  * Windows 版において PerMonitor v2 対応と同時に修正していますが macOS 版も同じように修正しています

* アクセサリ削除時頂点及びインデックスバッファが削除されずメモリ上に残り続ける
* エフェクトのパラメータ画面で特定条件下で落ちる

30.3.0 (2020/10/27)
******************************************

機能追加
==========================================

* emd を読み書きする機能を追加

  * ファイルメニューではなく :ref:`effect` から読み込みする方式です

* モデルまたはアクセサリ名を変更する機能を追加

  * 「:ref:`62EB4D2C-F84D-4B9A-A942-4216F524C01A`」及び「:ref:`806D1D25-22B4-4DE1-AE54-741A02FF923F`」を参照してください

不具合修正
==========================================

* IK 無効化時の IK リンクボーンの無効化処理が正しく行われない

  * 結果として :ref:`EFE0C3B6-39AF-4210-846A-B329D49B2611` の結果が意図しないものになっていた

* :ref:`F3B3AAC8-0D8C-4409-8439-8764F37F2962` 及び :ref:`EFE0C3B6-39AF-4210-846A-B329D49B2611` でモデルモーションの書き出しができない

  * 別モデルを選択してから再度書き出したいモデルを選択することによる回避は可能

* エフェクト利用時 APNG のデコードに失敗すると落ちる
* nmm 形式のプロジェクトファイル読み込み時にモデル名がプロジェクト内に重複してると先にモデルが適用され後からのモデルが読み込めない
* IK 有効時 IK ボーンを動かすと IK リンクが未登録判定される
* 付与親のもつ付与回転または付与移動が適用されない

30.2.0 (2020/9/21)
******************************************

機能追加
==========================================

* 音源及び背景動画を削除してリセットする機能を追加

不具合修正
==========================================

* エフェクト利用時モデル及びアクセサリの加算が効かない
* エラー発生時特定条件下で落ちる

  * エフェクトまたは準標準ボーンプラグイン利用時に発生しやすいが原理的にはそれ以外でも発生する可能性があった

30.1.0 (2020/8/31)
******************************************

機能追加
==========================================

* WAV (PCM) 音源をドラッグアンドドロップで読み込めるようにした

  * プラグインが必要な音源は読み込めないため従来どおりファイルダイアログから読み込んでください

不具合修正
==========================================

* テクスチャ名指定がファイルではなくフォルダになっている場合エラーが発生して読み込めない

  * フォルダ指定の場合テクスチャが存在しないものとして扱い読み込みを続けるようにしました

* ボーンまたはモーフ操作中に不意にカメラ操作が発動しないようにする仕組みを導入
* エフェクトの ``#include`` 句において階層構造が含まれるときにレアケースで機能しないことがある
* カリング無効と有効の材質が両方あると先に出た片方しか反映されない
* プロジェクト読み込みで WAV (PCM) 音源以外読み込まれず無音になる

  * プロジェクト読み込みにおいてプラグインによるデコードが必要な音源の読み込みができていなかったことが原因

* Windows 版で WAV (PCM) 音源をファイルダイアログから開くことができない

30.0.0 (2020/8/12)
******************************************

機能追加
==========================================

* マウスの中央ボタンを押しながらのカメラ移動の追加

  * もともと MMD にあったが nanoem では未実装だったため実装
  * 右上のカメラ移動のアイコンの挙動と同じだが移動幅を抑えるように調整

仕様変更
==========================================

* プロジェクト (nmm 形式) に保存するパスを絶対パスから相対パスに変更

  * 今回の変更により例えば DropBox のようなオンラインストレージでファイル同期を利用した際に別のマシンでも読み込めるようになります
  * 29.2.0 以前に保存したプロジェクトファイルは従来どおり読み込むことが可能ですが、新規プロジェクトでは相対パスで保存されます

    * 設定の切り替えは「:ref:`2F442197-62C2-468A-889A-E4FDF5D6E3F2`」で可能です

* プロジェクト読み込み時にアクセサリ、モデル、モデルの材質に割り当てられたエフェクトの中身がプロジェクト保存時とは違う内容になっていた場合エラーを出すように変更

  * 従来はスキップして読み込まれましたが気づけずファイル消失と勘違いする問題があるため明示的にエラーを出すようにしました

* カメラ変形方式の初期値を ``Global`` から ``Local`` に変更

  * MMD において ``Local`` が初期値であるため追従しました
  * モデルは従来どおり ``Local`` が初期値です

* 画像または動画の書き出しの際にプロジェクト保存を確認するかのダイアログを挟むようにした

  * 動画出力中に落ちる問題が発生することによる巻き戻りが起こることを防ぐために追加

* 画像書き出しの際に未登録のボーンまたはモーフがある場合エラーを出すようにした

  * 画像書き出しは仕様上フレーム移動が発生するため未登録のボーンまたはモーフがあると消失する問題の対策として追加

不具合修正
==========================================

* プロジェクト初期化で落ちることがある
* 編集及び再生中のフレームレートの「無制限」が機能しない
* IK無効化したあとIKリンクの回転がゼロ初期化されずに残り続ける

  * 関連で　IK 有効化無効化の切り替えを即座に反映されるようになりました

* IKリンクのボーンがIKボーンの後ろにあると正常に変形しない
* 右下のハンドル経由でのカメラ移動において ``Local`` が ``Global`` と同じ扱いで処理されていた
* 右上アイコンによるカメラ移動が MMD のそれと違う挙動になっていた
* シフトキー押したときカメラの移動またはズームができない

  * 背景動画操作と干渉してたことが原因であったため、背景動画が読み込まれないときはカメラの高速移動または高速ズームを行えるように修正
  * 背景動画が読み込まれたときは挙動が上書きされるため注意が必要です

* モデルプラグイン実行後に保存されるモデルが MMD で読み込めないものになる
* シフトあるいはコマンド（コントロール）キーを利用したハンドルの移動または回転をすると位置が飛ぶ
* Windows 版において明示的に拡張子をつけないとファイル保存に失敗する

  * 拡張子がなくてもファイル名だけで保存できるように修正しました

.. [#f1] GPU が利用できない場合 `WARP <https://docs.microsoft.com/en-us/windows/win32/direct3darticles/directx-warp>`_ を利用するように処理を追加したため原理的には発生しない
